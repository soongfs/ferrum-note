name: Auto Prerelease

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

concurrency:
  group: auto-prerelease-master
  cancel-in-progress: false

jobs:
  prepare-tag:
    if: >
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push' &&
      github.event.workflow_run.head_branch == 'master'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      tag_name: ${{ steps.tag.outputs.tag_name }}
      target_sha: ${{ steps.tag.outputs.target_sha }}
      created: ${{ steps.tag.outputs.created }}
    steps:
      - name: Checkout target commit
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Calculate and create alpha tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail

          target_sha="${{ github.event.workflow_run.head_sha }}"
          existing_tag="$(git tag --points-at "$target_sha" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+-alpha\.[0-9]+$' | head -n1 || true)"

          if [[ -n "$existing_tag" ]]; then
            echo "tag_name=$existing_tag" >> "$GITHUB_OUTPUT"
            echo "target_sha=$target_sha" >> "$GITHUB_OUTPUT"
            echo "created=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          base_version="$(node -p "require('./apps/desktop/package.json').version.split('-')[0]")"
          escaped_base="${base_version//./\\.}"
          max_alpha=-1

          while IFS= read -r tag; do
            [[ -z "$tag" ]] && continue
            if [[ "$tag" =~ ^v${escaped_base}-alpha\.([0-9]+)$ ]]; then
              alpha_number="${BASH_REMATCH[1]}"
              if (( alpha_number > max_alpha )); then
                max_alpha="$alpha_number"
              fi
            fi
          done < <(git tag -l "v${base_version}-alpha.*")

          next_alpha=$((max_alpha + 1))
          new_tag="v${base_version}-alpha.${next_alpha}"

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$new_tag" "$target_sha" -m "chore(release): auto cut $new_tag"
          git push origin "$new_tag"

          echo "tag_name=$new_tag" >> "$GITHUB_OUTPUT"
          echo "target_sha=$target_sha" >> "$GITHUB_OUTPUT"
          echo "created=true" >> "$GITHUB_OUTPUT"

  bundle:
    needs: prepare-tag
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    permissions:
      contents: read
    defaults:
      run:
        working-directory: apps/desktop
    steps:
      - name: Checkout tagged source
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-tag.outputs.tag_name }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile=false

      - name: Install Linux system dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev

      - name: Build bundles (non-Windows with tag version override)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          set -euo pipefail

          tag="${{ needs.prepare-tag.outputs.tag_name }}"
          version="${tag#v}"
          config_path="src-tauri/tauri.prerelease.json"

          cat > "$config_path" <<EOF
          {
            "version": "$version"
          }
          EOF

          pnpm tauri build --config "$config_path"

      - name: Build bundles (Windows prerelease wix version override)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $tag = "${{ needs.prepare-tag.outputs.tag_name }}"
          if ($tag -notmatch '^v(\d+)\.(\d+)\.(\d+)-alpha\.(\d+)$') {
            throw "Unexpected prerelease tag format: $tag"
          }

          $wixVersion = "$($matches[1]).$($matches[2]).$($matches[3]).$($matches[4])"
          $appVersion = $tag.TrimStart('v')
          $config = @{
            version = $appVersion
            bundle = @{
              windows = @{
                wix = @{
                  version = $wixVersion
                }
              }
            }
          } | ConvertTo-Json -Depth 6

          $configPath = "src-tauri/tauri.windows.prerelease.json"
          Set-Content -Path $configPath -Value $config -Encoding UTF8
          pnpm tauri build --config $configPath

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: tauri-prerelease-bundle-${{ matrix.os }}
          path: |
            target/release/bundle/**
            apps/desktop/src-tauri/target/release/bundle/**
          if-no-files-found: error

  publish-release:
    needs: [prepare-tag, bundle]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download bundle artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          pattern: tauri-prerelease-bundle-*
          merge-multiple: true

      - name: Publish prerelease assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-tag.outputs.tag_name }}
          target_commitish: ${{ needs.prepare-tag.outputs.target_sha }}
          prerelease: true
          generate_release_notes: true
          name: FerrumNote ${{ needs.prepare-tag.outputs.tag_name }}
          files: |
            release-assets/**/*.AppImage
            release-assets/**/*.deb
            release-assets/**/*.rpm
            release-assets/**/*.dmg
            release-assets/**/*.app.tar.gz
            release-assets/**/*.exe
            release-assets/**/*.msi
